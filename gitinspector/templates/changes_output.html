<div id="changes_div">
  <div class="box">

    <div class="box_title" style="display:inline-block">
      Changes summary
    </div>

    <div id="changes_box"
         style="display: flex; align-items: center">

      <div style="width:75%">
        <table id="changes_table" class="git2">
          <thead>
            <tr>
              <th/>
              <th>Author</th>
              <th>Commits</th>
              <th>Insertions</th>
              <th>Deletions</th>
              <th>Types</th>
              <th>% of changes</th>
              <th/>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <th class="hoverable" colspan="8">
              </th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div>
        <svg id="changes_svg" width="290" height="220">
        </svg>
      </div>
    </div>

    <script>
      (function () {
          var changes_data = $changes_data;
          // Control which data appear inside the pie
          var changes_filter = d => d.changes > 0.5;
          var changes_data_pie = changes_data.filter(changes_filter);
          var sum_changes = 0;
          changes_data_pie.forEach(function (d) { sum_changes += d.changes; });
          // Append the remaining changes as the last element of the pie
          changes_data_pie.push({changes: 100-sum_changes, color: "#cccccc"});

          var titles = Object.keys(changes_data[0]).filter(t => t != "color");

          var svg = d3.select("svg#changes_svg"),
              width = svg.attr("width"),
              height = svg.attr("height"),
              radius = Math.min(width, height) / 2,
              group = svg.append("g").attr("transform",
                                       "translate(" + width / 2 + "," + height / 2 + ")");

          // Generate the pie
          var arcs = generate_pie(group, radius, changes_data_pie,
                                  d => d.changes, d => d.data.color);
          // Generate the table
          var lines = generate_sortable_table("changes_table", titles, changes_data, changes_filter);

	  // Generate the commit types
	  d3.selectAll("svg.changes_svg_types").
	      attr("width", 82).
	      attr("height", 25).
	      each(function () {
		  var el = d3.select(this);
		  var values = JSON.parse(el.attr("values"));
		  var dx = 1;
		  values.forEach( function(v,i) {
		      el.append("rect").
			  attr("width", 0.8*v).attr("x", dx).
			  attr("height", 15).attr("y", 5).
			  attr("fill", d3.hsl(60*i,0.6,0.6)).
			  on("mouseover", function(d, i){
			      var r = d3.select(this);
			      r.attr("fill", d3.color(r.attr("fill")).brighter()); }).
			  on("mouseout", function(d, i){
			      var r = d3.select(this);
			      r.attr("fill", d3.color(r.attr("fill")).darker()); }).
			  append("title").html(v.toFixed(2) + "%");
		      dx += 0.8*v;
		  });
		  el.append("rect").attr("width", 81).attr("height", 15).
		      attr("x", 1).attr("y", 5).attr("stroke", "#333333").
		      attr("fill", "none");
	      });

          // Link pie chart sections with lines
          link_table_and_pie(lines, arcs);

	  // Register the div in the summary
	  register_box("Changes summary", "changes_div");
      })();
    </script>

  </div>
</div>
