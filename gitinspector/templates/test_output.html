<div>
  <div class="box">

    <div style="width: 20px; position: absolute">
      <div id="timeline_label" class="git2 visible">
        Timeline
      </div>
    </div>

    <div id="timeline_tmp"></div>

    <div id="timeline_box"
         style="display: flex; align-items: center">

      <div>
        <svg id="timeline_svg" width="980" height="600">
        </svg>
      </div>

    </div>

    <script>
      (function () {
          var timeline = $timeline;
          // d3.select("div#timeline_tmp").html(JSON.stringify(timeline));

	  var svg = d3.select("svg#timeline_svg"),
              width = parseInt(svg.attr("width")),
              height = parseInt(svg.attr("height")),
	      xsep = 130, ysep = 80,
	      dx = (width-xsep)/(timeline.max_period+2),
	      dy = (height-ysep)/(Object.keys(timeline.authors).length+1);
	  var x = d3.scaleOrdinal()
	      .domain(timeline.periods.map(d => d[0]))
	      .range(timeline.periods.map(d => xsep + dx + (width-xsep-2*dx)*d[1]/timeline.max_period));
	  var y = d3.scaleBand()
	      .domain(Object.keys(timeline.authors))
	      .range([ysep+dy/2, height-dy/2]);

	  var xAxis = d3.axisTop(x).tickValues(timeline.periods.map(d => d[0]));
	  var gaxis = svg.append("g").attr("transform", "translate(0," + ysep + ")");
	  gaxis.call(xAxis).selectAll("text")
	      .attr("y", 0).attr("x", 9)
	      .attr("dy", ".35em")
	      .attr("transform", "rotate(-90)")
	      .style("text-anchor", "start");
	  gaxis.selectAll(".tick line").attr("stroke", "#ccc").attr("y1", height-ysep-dy);

	  var gauths = svg.append("g").attr("transform", "translate(" + xsep/2 + "," + 10 + ")");
	  var aheight = Math.min(dy, 50);
	  Object.keys(timeline.authors).forEach(function (a) {
      	      gauths.append("rect").attr("y", y(a)-aheight/2+5).attr("height", aheight-10)
      		  .attr("x", -xsep/2).attr("width", xsep).attr("rx", 10).attr("ry", 10)
      		  .attr("fill", timeline.authors[a]).attr("opacity", 0.5);
      	      gauths.append("text").attr("y", y(a)+2)
      		  .style("text-anchor", "middle")
      		  .style("font-size", "x-small")
      		  .text(a);
	  });

	  var gentries = svg.append("g");
	  Object.keys(timeline.entries).forEach(function(p) {
      	      var commits = timeline.entries[p];
      	      var a = x(p);
      	      var b = height-dy;
      	      commits.forEach(function(c) {
		  var work = c["work"] * (height-ysep-dy) / timeline.max_work;
      		  b -= work;
      		  gentries.append("rect").attr("x", a-dx/2).attr("y", b)
      		      .attr("height", work).attr("width", dx)
      		      .attr("fill", timeline.authors[c["author"]]);
      	      });
	  });

	  var div = d3.select("div#timeline_box").append("div")
	      .attr("class", "tooltip")
	      .style("opacity", 0);

          // Make the div hideable
          make_box_hideable("timeline_label", "timeline_box", "flex");
      })();
    </script>

  </div>
</div>
